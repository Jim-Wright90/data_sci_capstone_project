---
title: "Educational Data Science Capstone Project"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    vertical_layout: scroll
    theme: united
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(here)
library(janitor)
library(rio)
library(colorblindr)
library(gghighlight)
library(forcats)
library(ggrepel)
library(gt)
library(knitr)
library(kableExtra)
library(reactable)
library(plotly)
library(glue)
library(fs)
library(rstatix)
library(ggpubr)
library(writexl)
library(remotes)

theme_set(theme_minimal(15) +
            theme(legend.position = "bottom",
                  panel.grid.major.x = element_line(color = "gray60"),
                  panel.grid.minor.x = element_blank(),
                  panel.grid.major.y = element_blank())
          )
```

```{r, include=FALSE}
# all impact data 

impact_all <- read_csv(here("data", "impact_data.csv"))

str(impact_all)


#all clean sims data
sims_concussion_data <- read_csv(here("data", "sims_concussion_data.csv"))

str(sims_concussion_data)

#impact data only

one_impact_test <- read_csv(here("data", "one_post_injury_impact_test.csv"))

str(one_impact_test)

two_impact_test <- read_csv(here("data", "two_post_injury_impact_test.csv"))

three_impact_test <- read_csv(here("data", "three_post_injury_impact_test.csv"))

four_impact_test <- read_csv(here("data", "four_post_injury_impact_test.csv"))

# impact sims merge data

one_impact_sims <- read_csv(here("data", "one_post_injury_test_impact_sims_merge.csv"))

str(one_impact_sims)

two_impact_sims <- read_csv(here("data", "two_post_injury_test_impact_sims_merge.csv"))

three_impact_sims <- read_csv(here("data", "three_post_injury_test_impact_sims_merge.csv"))

four_impact_sims <- read_csv(here("data", "four_post_injury_test_impact_sims_merge.csv"))

# pcss items 

pcss_items <- import(here("data", "pcss_items.xlsx"),
               setclass = "tbl_df") 

pcss_cluster <- import(here("data", "cluster_scores.xlsx"),
               setclass = "tbl_df") 
```

```{r, include=FALSE}
#helpful functions 

mean_2 <- function(x) {
  z <- na.omit(x)
  sum(z) / length(z)
}

my_mean <- function(x) {
  mean(x[x >= 0], na.rm = TRUE)
}

create_react_time <- function(df, var) {
    df %>% 
      summarize(Mean = mean({{var}}),
                SD = sd({{var}}),
                Min = min({{var}}),
                Max = max({{var}}),
                Total = length({{var}})) %>% 
      mutate_if(is.numeric, round, 2) %>% 
      reactable(columns = list(
        Mean = colDef(format = colFormat(separators = TRUE, suffix = " days")),
        SD = colDef(format = colFormat(separators = TRUE, suffix = " days")),
        Min = colDef(format = colFormat(separators = TRUE, suffix = " days")),
        Max = colDef(format = colFormat(separators = TRUE, suffix = " days")),
        Total = colDef(format = colFormat(separators = TRUE, suffix = " concussions"))
      ))
}

create_react <- function(df, var) {
    df %>% 
      summarize(Mean = mean({{var}}),
                SD = sd({{var}}),
                Min = min({{var}}),
                Max = max({{var}}),
                Total = length({{var}})) %>% 
      mutate_if(is.numeric, round, 2) %>% 
      reactable(columns = list(
        Mean = colDef(format = colFormat(separators = TRUE)),
        SD = colDef(format = colFormat(separators = TRUE)),
        Min = colDef(format = colFormat(separators = TRUE)),
        Max = colDef(format = colFormat(separators = TRUE)),
        Total = colDef(format = colFormat(separators = TRUE, suffix = " concussions"))
      ))
}

```


# Data Overview 

Sidebar {.sidebar}
------------

**_Data Description:_** The data for this capstone project was provided by the Hawaii Concussion Awareness and Management Program [(HCAMP)](https://hawaiiconcussion.com/), which is an organization affiliated with the University of Hawaii. The mission of HCAMP is to develop evidence-based interventions to manage concussion. 

The specific goal of this project is to explore trends from two data sets. The first data set contains multiple years of test and symptom severity scores from the Immediate Post-Concussion Assessment and Cognitive Testing [(ImPACT)](https://impactconcussion.com/) software. The second data set contains multiple years of return-to-learn (RTL) and return-to-play (RTP) outcome data from the Hawaii Department of Education Student Information Management System (SIMS). The ImPACT data set is utilized to explore trends in symptom severity, as measured by the [Post-Concussion Symptom Scale (PCSS)](tools/Post-Concussion-Symptom-Scale1.pdf), across individuals who completed post-injury testing following their concussion. The ImPACT data set is divided into four smaller data sets to represent individuals who completed one post-injury test, two post-injury tests, three post-injury tests, and four post-injury tests. Specific to this data set, the following research question is explored: Is there a significant difference between PCSS cluster symptom scores during the recovery process? The six symptom clusters used for this project are adapted from Lumba-Brown et al. (2019) and Harmon et al. (2019). 

The SIMS data set is utilized to explore trends in the duration of time to complete RTL and RTP protocols. The ImPACT and SIMS data sets have been joined corresponding to the number of post-injury tests completed from the ImPACT data set. Although the merger of these data sets did not yield a large number of observations to analyze, the following research question is explored: What is the relationship between symptom severity scores and RTL/RTP duration? 

The top row of the *Data Overview* tab displays information on the number of individuals who completed multiple ImPACT tests as well as information on the PCSS. The bottom row displays information on the complete SIMS data set, consisting of individuals who experienced a documented concussion and were tracked for recovery during the RTL and RTP process. 


Row {.tabset}
-----------------------------------------------------------------------

### ImPACT Test Totals

```{r, include=FALSE}
t_sum_pi <- data.frame("Level" = c("One Post-Injury Test",
                                  "Two Post-Injury Tests",
                                  "Three Post-Injury Tests",
                                  "Four Post-Injury Tests"),
                      "Total" = c(9991,
                                  5295,
                                  2228,
                                  780))
```

```{r, include=FALSE}
t_sum_pi %>% 
  reactable(columns = list(
    Level = colDef(name = "Level",
                   align = "center"),
    Total = colDef(name = "Total", 
                   align = "center",
                   format = colFormat(separators = TRUE, suffix = " individuals"))),
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE)
```

```{r, include=FALSE}
pi_plot <- ggplot(t_sum_pi, aes(fct_reorder(Level, Total), Total)) +
  geom_col(fill = "blue",
           alpha = 0.7) +
  scale_y_continuous(labels = function(x) format(x, big.mark = ",",
                                                 scientific = FALSE)) +
  coord_flip() +
  labs(x = "",
       y = "Individuals")
```

```{r, include=TRUE}
ggplotly(pi_plot)
```

### PCSS Item Description

```{r}
pcss_items %>% 
  reactable(columns = list(
    Item = colDef(name = "Item",
                   align = "center"),
    Symptom = colDef(name = "Symptom", 
                   align = "center"),
    Cluster = colDef(name = "Cluster",
                     align = "center")),
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE,
    searchable = TRUE)
```

### PCSS Symptom Clusters

```{r, include=FALSE}
head(pcss_cluster)

pcss_cluster_plot <- ggplot(pcss_cluster, aes(fct_reorder(Cluster, `Total Possible Severity Score`),
                                              `Total Possible Severity Score`)) +
  geom_col(fill = "blue",
           alpha = 0.7) +
  scale_y_continuous(limits = c(0, 30),
                     breaks = c(0, 5, 10, 15, 20, 25, 30)) +
  coord_flip() +
  labs(x = "",
       y = "Total Possible Severity Score",
       caption = "Total Possible Severity Score = 132")
```

```{r, include=TRUE}
ggplotly(pcss_cluster_plot)
```

Row {.tabset}
-----------------------------------------------------------------------

### Sims - Gender 

```{r, include=FALSE}
sims_concussion_data %>% 
  group_by(gender) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total)) %>% 
  reactable(
    columns = list(
      gender = colDef(name = "Gender",
                      align = "center"),
      total = colDef(name = "Total",
                     align = "center",
                     format = colFormat(suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE
    )
```

```{r, include=FALSE}
sims_gender <- sims_concussion_data %>% 
  group_by(gender) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total))

sims_gender_plot <- ggplot(sims_gender, aes(fct_reorder(gender, total), total)) +
  geom_col(fill = "blue",
           alpha = 0.7) +
  scale_y_continuous(limits = c(0, 600),
                     breaks = c(0, 200, 400, 600)) +
  coord_flip() +
  labs(x = "",
       y = "Total")
```

```{r, include=TRUE}
ggplotly(sims_gender_plot)
```

### Sims - Age

```{r, include=FALSE}
sims_concussion_data %>% 
  group_by(age) %>% 
  summarize(total = n()) %>% 
  reactable(
    columns = list(
      age = colDef(name = "Age",
                      align = "center"),
      total = colDef(name = "Total",
                     align = "center",
                     format = colFormat(suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE
    )
```

```{r, include=FALSE}
sims_age <- sims_concussion_data %>% 
  mutate(age = as.factor(age)) %>% 
  group_by(age) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total))



sims_age_plot <- ggplot(sims_age, aes(fct_reorder(age, total), total)) +
  geom_col(fill = "blue",
           alpha = 0.7) +
  coord_flip() +
  labs(x = "Age",
       y = "Total")
```

```{r, include=TRUE}
ggplotly(sims_age_plot)
```

### Sims - League

```{r, include=FALSE}
sims_concussion_data %>% 
  group_by(league) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total)) %>% 
  reactable(
    columns = list(
      league = colDef(name = "League",
                      align = "center"),
      total = colDef(name = "Total",
                     align = "center",
                     format = colFormat(suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE
    )
```

```{r, include=FALSE}
sims_league <- sims_concussion_data %>% 
  group_by(league) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total))

sims_league_plot <- ggplot(sims_league, aes(fct_reorder(league, total), total)) +
  geom_col(fill = "blue",
           alpha = 0.7) +
  scale_y_continuous(limits = c(0, 500),
                     breaks = c(0, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500)) +
  coord_flip() +
  labs(x = "",
       y = "Total")
```

```{r, include=TRUE}
ggplotly(sims_league_plot)
```

### Sims - School

```{r}
sims_concussion_data %>% 
  group_by(school) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total)) %>% 
  reactable(
    columns = list(
      school = colDef(name = "School",
                      align = "center"),
      total = colDef(name = "Total",
                     align = "center",
                     format = colFormat(suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE,
    searchable = TRUE
    )
```

### Sims - Sport

```{r}
sims_concussion_data %>% 
  group_by(sport) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total)) %>% 
  reactable(
    columns = list(
      sport = colDef(name = "Sport",
                      align = "center"),
      total = colDef(name = "Total",
                     align = "center",
                     format = colFormat(suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE,
    searchable = TRUE
    )
```

### Sims - Sport Level

```{r, include=FALSE}
sims_concussion_data %>% 
  group_by(level) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total)) %>% 
  reactable(
    columns = list(
      level = colDef(name = "Level",
                      align = "center"),
      total = colDef(name = "Total",
                     align = "center",
                     format = colFormat(suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE
    )
```

```{r, include=FALSE}
sims_level <- sims_concussion_data %>% 
  group_by(level) %>% 
  summarize(total = n()) %>% 
  arrange(desc(total))

sims_level_plot <- ggplot(sims_level, aes(fct_reorder(level, total), total)) +
  geom_col(fill = "blue",
           alpha = 0.7) +
  scale_y_continuous(limits = c(0, 500),
                     breaks = c(0, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500)) +
  coord_flip() +
  labs(x = "",
       y = "Total")
```

```{r, include=TRUE}
ggplotly(sims_level_plot)
```

### Sims - RTL Summary 

```{r, include=TRUE}
create_react_time(sims_concussion_data, dys_btwn_onset_rtp_3)
```

### Sims - RTL Plot 

```{r, include=FALSE}
rtl_smry_plot <- ggplot(sims_concussion_data, aes(dys_btwn_onset_rtp_3)) +
  geom_histogram(fill = "#56B4E9",
                color = "white", 
                alpha = 0.9,
                bins = 10) +
  facet_wrap(~gender, nrow = 1) +
  labs(x = "Days to Complete RTL",
       y = "")
```

```{r, include=TRUE}
ggplotly(rtl_smry_plot)
```

### Sims - RTP Summary 

```{r, include=TRUE}
create_react_time(sims_concussion_data, dys_btwn_onset_rtp_7)
```

### Sims - RTP Plot

```{r, include=FALSE}
rtp_smry_plot <- ggplot(sims_concussion_data, aes(dys_btwn_onset_rtp_7)) +
  geom_histogram(fill = "#56B4E9",
                color = "white", 
                alpha = 0.9,
                bins = 10) +
  facet_wrap(~gender, nrow = 1) +
  labs(x = "Days to Complete RTP",
       y = "")
```

```{r, include=TRUE}
ggplotly(rtp_smry_plot)
```


# One Post-Injury Test 

Sidebar {.sidebar}
------------

**_Description:_** This tab provides summaries and visualizations of PCSS severity scores for the 9,991 concussion cases where the individual completed one post-injury test during recovery. 

Row {.tabset}
-----------------------------------------------------------------------

### Total Symptom Score Histogram 

```{r, include=FALSE}
head(one_impact_test)

score_hist <- function(df, x) {
  ggplot(df, aes({{x}})) +
  geom_histogram(fill = "#56B4E9",
                color = "white", 
                alpha = 0.9,
                bins = 25) +
    labs(x = "Symptom Severity",
         y = "Number of Individuals")
}

gender_hist <- function(df, x) {
  ggplot(df, aes({{x}})) +
  geom_histogram(fill = "#56B4E9",
                color = "white", 
                alpha = 0.9,
                bins = 25) +
    facet_wrap(~gender) +
    labs(x = "Symptom Severity",
         y = "")
}

```

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, total_symptom_score_post_injury_1))

```

### Total Symptom Score Summary

```{r, include=TRUE}
create_react(one_impact_test, total_symptom_score_post_injury_1)
```

### Total Symptom Score Summary - Gender 

```{r, include=FALSE}
gender_symptom_tbl <- function(df, x) {
  df %>% 
  group_by(gender) %>% 
  summarize(mean = mean({{x}}),
            sd = sd({{x}}),
            min = min({{x}}),
            max = max({{x}}),
            total = length({{x}})) %>%
  mutate(mean = as.numeric(mean),
         sd = as.numeric(sd),
         min = as.numeric(min),
         max = as.numeric(max),
         total = as.numeric(total)) %>% 
  reactable(
    columns = list(
      gender = colDef(name = "Gender"),
      mean = colDef(name = "Mean",
                    format = colFormat(digits = 2, separators = TRUE)),
      sd = colDef(name = "SD",
                  format = colFormat(digits = 2, separators = TRUE)),
      min = colDef(name = "Min",
                   format = colFormat(separators = TRUE)),
      max = colDef(name = "Max",
                   format = colFormat(separators = TRUE)),
      total = colDef(name = "Total",
                   format = colFormat(separators = TRUE, suffix = " concussions"))),
    pagination = TRUE,
    striped = TRUE,
    outlined = TRUE,
    compact = TRUE,
    highlight = TRUE,
    bordered = TRUE
  )
}

gender_symptom_tbl(one_impact_test, total_symptom_score_post_injury_1)

```

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, total_symptom_score_post_injury_1)
```

### Total Symptom Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, total_symptom_score_post_injury_1))
```

Row {.tabset}
-----------------------------------------------------------------------

### Headache-Migraine Cluster Score Histogram 

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, headache_migraine_cluster_score_post_injury_1))
```

### Headache-Migraine Cluster Score Summary

```{r, include=TRUE}
create_react(one_impact_test, headache_migraine_cluster_score_post_injury_1)
```

### Headache-Migraine Cluster Score Summary - Gender 

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, headache_migraine_cluster_score_post_injury_1)
```

### Headache-Migraine Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, headache_migraine_cluster_score_post_injury_1))
```


Row {.tabset}
-----------------------------------------------------------------------

### Cognitive Cluster Score Histogram 

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, cognitive_cluster_score_post_injury_1))
```

### Cognitive Cluster Score Summary

```{r, include=TRUE}
create_react(one_impact_test, cognitive_cluster_score_post_injury_1)
```

### Cognitive Cluster Score Summary - Gender 

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, cognitive_cluster_score_post_injury_1)
```

### Cognitive Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, cognitive_cluster_score_post_injury_1))
```

Row {.tabset}
-----------------------------------------------------------------------

### Anxiety-Mood Cluster Score Histogram 

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, anxiety_mood_cluster_score_post_injury_1))
```

### Anxiety-Mood Cluster Score Summary

```{r, include=TRUE}
create_react(one_impact_test, anxiety_mood_cluster_score_post_injury_1)
```

### Anxiety-Mood Cluster Score Summary - Gender 

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, anxiety_mood_cluster_score_post_injury_1)
```

### Anxiety-Mood Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, anxiety_mood_cluster_score_post_injury_1))
```

Row {.tabset}
-----------------------------------------------------------------------

### Ocular-Motor Cluster Score Histogram 

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, ocular_motor_cluster_score_post_injury_1))
```

### Ocular-Motor Cluster Score Summary

```{r, include=TRUE}
create_react(one_impact_test, ocular_motor_cluster_score_post_injury_1)
```

### Ocular-Motor Cluster Score Summary - Gender 

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, ocular_motor_cluster_score_post_injury_1)
```

### Ocular-Motor Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, ocular_motor_cluster_score_post_injury_1))
```

Row {.tabset}
-----------------------------------------------------------------------

### Vestibular Cluster Score Histogram 

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, vestibular_cluster_score_post_injury_1))
```

### Vestibular Cluster Score Summary

```{r, include=TRUE}
create_react(one_impact_test, vestibular_cluster_score_post_injury_1)
```

### Vestibular Cluster Score Summary - Gender 

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, vestibular_cluster_score_post_injury_1)
```

### Vestibular Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, vestibular_cluster_score_post_injury_1))
```

Row {.tabset}
-----------------------------------------------------------------------

### Sleep Cluster Score Histogram 

```{r, include=TRUE}
ggplotly(score_hist(one_impact_test, sleep_cluster_score_post_injury_1))
```

### Sleep Cluster Score Summary

```{r, include=TRUE}
create_react(one_impact_test, sleep_cluster_score_post_injury_1)
```

### Sleep Cluster Score Summary - Gender 

```{r, include=TRUE}
gender_symptom_tbl(one_impact_test, sleep_cluster_score_post_injury_1)
```

### Sleep Score Gender Visual Comparison

```{r, include=TRUE}
ggplotly(gender_hist(one_impact_test, sleep_cluster_score_post_injury_1))
```
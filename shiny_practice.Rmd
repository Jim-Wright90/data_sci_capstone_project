---
title: "Educational Data Science Capstone Project"
runtime: shiny  
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    vertical_layout: scroll
    theme: united
---

```{r setup, include=FALSE}
library(shiny)
library(flexdashboard)
library(tidyverse)
library(here)
library(janitor)
library(rio)
library(colorblindr)
library(gghighlight)
library(forcats)
library(ggrepel)
library(gt)
library(knitr)
library(kableExtra)
library(reactable)
library(plotly)
library(glue)
library(fs)
library(rstatix)
library(ggpubr)
library(writexl)
library(remotes)

theme_set(theme_minimal(15) +
            theme(legend.position = "bottom",
                  panel.grid.major.x = element_line(color = "gray60"),
                  panel.grid.minor.x = element_blank(),
                  panel.grid.major.y = element_blank())
          )
```

```{r global, include=FALSE}
# all impact data 

impact_all <- read_csv(here("data", "impact_data.csv"))

str(impact_all)


#all clean sims data
sims_concussion_data <- read_csv(here("data", "sims_concussion_data.csv"))

str(sims_concussion_data)

sims_concussion_data <- sims_concussion_data %>% 
  mutate(age = as.factor(age))

str(sims_concussion_data)

#impact data only

one_impact_test <- read_csv(here("data", "one_post_injury_impact_test.csv"))

str(one_impact_test)

two_impact_test <- read_csv(here("data", "two_post_injury_impact_test.csv"))

three_impact_test <- read_csv(here("data", "three_post_injury_impact_test.csv"))

four_impact_test <- read_csv(here("data", "four_post_injury_impact_test.csv"))

# impact sims merge data

one_impact_sims <- read_csv(here("data", "one_post_injury_test_impact_sims_merge.csv"))

str(one_impact_sims)

two_impact_sims <- read_csv(here("data", "two_post_injury_test_impact_sims_merge.csv"))

three_impact_sims <- read_csv(here("data", "three_post_injury_test_impact_sims_merge.csv"))

four_impact_sims <- read_csv(here("data", "four_post_injury_test_impact_sims_merge.csv"))

# pcss items 

pcss_items <- import(here("data", "pcss_items.xlsx"),
               setclass = "tbl_df") 

pcss_cluster <- import(here("data", "cluster_scores.xlsx"),
               setclass = "tbl_df") 
```


# Data Overview 

Sidebar {.sidebar}
------------

**SIMS Data Variable Exploration**

```{r, include=TRUE}
selectInput("var1", "Sims Demographic Variables:",
            choices = c("Gender" = "gender",
                        "Age" = "age",
                        "League" = "league",
                        "Sport Level" = "level"))

selectInput("var2", "Sims Demographic Variables:",
            choices = c("School" = "school",
                        "Sport" = "sport"))

```


**SIMS RTL/RTP information**

```{r, inlcude=TRUE}

selectInput("var3", "Sims Demographic Variables:",
            choices = c("Gender" = "gender",
                        "Age" = "age",
                        "League" = "league",
                        "Sport Level" = "level"))

```

Row {.tabset}
-----------------------------------------------------------------------

### Concussion Totals 1

```{r}
# Define inputs 

renderPlotly({
  sims_concussion_data %>%
    ggplot(aes_string(input$var1)) +
    geom_bar(fill = "blue",
             alpha = 0.7) +
    coord_flip() +
    labs(x = "",
         y = "Total Concussions")
})

```

### Concussion Totals 2

```{r, include=FALSE}
# tbl_1 <- sims_concussion_data %>%
#   group_by({{input$var2}}) %>%
#   summarize(total = n()) %>%
#   arrange(desc(total)) %>%
#   reactable(
#     columns = list(
#       {{input$var2}} = colDef(align = "center"),
#       total = colDef(name = "Total",
#                      align = "center",
#                      format = colFormat(suffix = " concussions"))),
#     pagination = TRUE,
#     striped = TRUE,
#     outlined = TRUE,
#     compact = TRUE,
#     highlight = TRUE,
#     bordered = TRUE
#     )
```

```{r, include=TRUE}
 renderReactable(tbl_1)
```


Row {.tabset}
-----------------------------------------------------------------------

### RTL

```{r, include=FALSE}

renderPlotly({
  ggplot(sims_concussion_data, aes(dys_btwn_onset_rtp_3)) +
  geom_histogram(bins = input$var3,
                fill = "#56B4E9",
                color = "white",
                alpha = 0.9) +
  facet_wrap(~input$var3, nrow = 1) +
  labs(x = "Days to Complete RTL",
       y = "")
})
```

### RTP

```{r, include=FALSE}

renderPlotly({
  ggplot(sims_concussion_data, aes(dys_btwn_onset_rtp_7)) +
  geom_histogram(bins = input$var3,
                 fill = "#56B4E9",
                color = "white",
                alpha = 0.9) +
  facet_wrap(~input$var3, nrow = 1) +
  labs(x = "Days to Complete RTP",
       y = "")
})
```